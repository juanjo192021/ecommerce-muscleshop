<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Bienvendidos a MuscleShop</title>

    <meta name="author" content="Muscle">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- font -->
    <link rel="stylesheet" th:href="@{/public/resources/site/general/static/assets/fonts/fonts.css}">
    <!-- Icons -->
    <link rel="stylesheet" th:href="@{/public/resources/site/general/static/assets/fonts/font-icons.css}">
    <link rel="stylesheet" th:href="@{/public/resources/site/general/static/assets/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/public/resources/site/general/static/assets/css/swiper-bundle.min.css}">
    <link rel="stylesheet" th:href="@{/public/resources/site/general/static/assets/css/animate.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/public/resources/site/general/static/assets/css/styles.css}"/>

    <!-- Favicon and Touch Icons  -->
    <link rel="shortcut icon" th:href="@{/public/resources/site/general/static/images/logo/favicon.png}">
    <link rel="apple-touch-icon-precomposed" th:href="@{/public/resources/site/general/static/images/logo/favicon.png}">
    <script src="https://kit.fontawesome.com/98270ba09b.js" crossorigin="anonymous"></script>
</head>
<body class="preload-wrapper">
<!-- preload -->
<div class="preload preload-container">
    <div class="preload-logo">
        <div class="spinner"></div>
    </div>
</div>
<!-- /preload -->
<div id="wrapper">
    <!-- Top bar -->
    <div th:replace="~{shared/components/top-bar :: top-bar}"></div>
    <!-- /Top bar -->
    <!-- Header -->
    <div th:replace="~{shared/components/header :: header}"></div>
    <!-- /Header -->

    <!-- page-title -->
    <div class="tf-page-title">
        <div class="container-full">
            <div class="row">
                <div class="col-12">
                    <div class="heading text-center">Por Objetivos</div>
                </div>
            </div>
        </div>
    </div>
    <!-- /page-title -->

    <section class="flat-spacing-1">
        <div class="container">
            <div class="tf-shop-control grid-3 align-items-center">
                <div></div>
                <ul class="tf-control-layout d-flex justify-content-center">
                    <li class="tf-view-layout-switch sw-layout-2" data-value-grid="grid-2">
                        <div class="item"><span class="icon icon-grid-2"></span></div>
                    </li>
                    <li class="tf-view-layout-switch sw-layout-3 active" data-value-grid="grid-3">
                        <div class="item"><span class="icon icon-grid-3"></span></div>
                    </li>
                    <li class="tf-view-layout-switch sw-layout-4" data-value-grid="grid-4">
                        <div class="item"><span class="icon icon-grid-4"></span></div>
                    </li>

                </ul>
            </div>
            <div class="tf-row-flex">
                <div class="tf-shop-sidebar wrap-sidebar-mobile">

                    <div class="widget-facet wd-categories">
                        <div class="facet-title" data-bs-target="#por-objetivos" data-bs-toggle="collapse" aria-expanded="false" aria-controls="por-objetivos">
                            <span>Por Objetivos</span>
                            <!--class="icon icon-arrow-up"-->
                            <span class="icon icon-arrow-down"></span>
                        </div>
                        <div id="por-objetivos" class="collapse">
                            <ul class="list-categoris current-scrollbar mb_36">
                                <li class="cate-item" th:each="objetivo : ${objetivos}">
                                    <a th:href="@{'/por-objetivos/'+ ${objetivo.url}}">
                                        <span th:text="${objetivo.nombre}">Dress</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <div class="widget-facet wd-categories">
                        <div class="facet-title" data-bs-target="#por-marcas" data-bs-toggle="collapse" aria-expanded="false" aria-controls="por-marcas">
                            <span>Por Marcas</span>
                            <span class="icon icon-arrow-down"></span>
                        </div>
                        <div id="por-marcas" class="collapse">
                            <ul class="list-categoris current-scrollbar mb_36">
                                <li class="cate-item" th:each="marca : ${marcas}">
                                    <a th:href="@{'/por-marcas/'+ ${marca.url}}">
                                        <span th:text="${marca.nombre}">Dress</span>
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>

                    <form action="#" id="facet-filter-form" class="facet-filter-form">
                        <!--<div class="widget-facet">
                            <div class="facet-title" data-bs-target="#availability" data-bs-toggle="collapse" aria-expanded="true" aria-controls="availability">
                                <span>Availability</span>
                                <span class="icon icon-arrow-up"></span>
                            </div>
                            <div id="availability" class="collapse show">
                                <ul class="tf-filter-group current-scrollbar mb_36">
                                    <li class="list-item d-flex gap-12 align-items-center">
                                        <input type="radio" name="availability" class="tf-check" id="availability-1">
                                        <label for="availability-1" class="label"><span>In stock</span>&nbsp;<span>(14)</span></label>
                                    </li>
                                    <li class="list-item d-flex gap-12 align-items-center">
                                        <input type="radio" name="availability" class="tf-check" id="availability-2">
                                        <label for="availability-2" class="label"><span>Out of stock</span>&nbsp;<span>(2)</span></label>
                                    </li>
                                </ul>
                            </div>
                        </div>-->
                        <div class="widget-facet wrap-price">
                            <div class="facet-title" data-bs-target="#price" data-bs-toggle="collapse" aria-expanded="true" aria-controls="price">
                                <span>Precio</span>
                                <span class="icon icon-arrow-up"></span>
                            </div>
                            <div id="price" class="collapse show">
                                <div class="widget-price filter-price">
                                    <div class="tow-bar-block">
                                        <div class="progress-price"></div>
                                    </div>
                                    <div class="range-input">
                                        <input class="range-min" type="range" min="0" max="1000" value="0"/>
                                        <input class="range-max" type="range" min="0" max="1000" value="1000"/>
                                    </div>
                                    <div class="box-title-price">
                                        <span class="title-price">Precio :</span>
                                        <div class="caption-price">
                                            <div>
                                                <span>S/</span>
                                                <span class="min-price">0</span>
                                            </div>
                                            <span>-</span>
                                            <div>
                                                <span>S/</span>
                                                <span class="max-price">1000</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4">
                                        <button id="btn-aplicar-filtros"
                                                class="btn btn-dark"
                                                type="button">
                                            Aplicar Filtros
                                        </button>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </form>
                </div>
                <div class="tf-shop-content wrapper-control-shop">
                    <div class="meta-filter-shop"></div>
                    <div class="grid-layout wrapper-shop" data-grid="grid-3" id="contenedor-producto">
                        <!-- card product 1 -->

                    </div>
                    <!-- pagination -->
                    <ul class="tf-pagination-wrap tf-pagination-list tf-pagination-btn">

                    </ul>
                </div>
            </div>
        </div>
    </section>

    <div class="btn-sidebar-mobile start-0">
        <a href="#filterShop" data-bs-toggle="offcanvas" aria-controls="offcanvasLeft">
            <button class="type-hover">
                <i class="icon-open"></i>
                <span class="fw-5">Open sidebar</span>
            </button>
        </a>
    </div>

    <!-- Footer -->
    <div th:replace="~{shared/components/footer :: footer}"></div>
    <!-- /Footer -->

</div>

<!-- gotop: Componente que hace dirigirte a lo m치s alto de la p치gina web-->
<div th:replace="~{shared/components/gotop :: gotop}"></div>
<!-- /gotop -->

<!-- toolbar-bottom: Componente inferior cuando es mobile similar a un toolbar-->
<div th:replace="~{shared/components/toolbar-bottom :: toolbar-bottom}"></div>
<!-- /toolbar-bottom -->

<!-- all-modals: Todos los modales -->
<div th:replace="~{shared/modals/all-modals :: all-modals}"></div>
<!-- /all-modals -->

<!-- Javascript -->
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/bootstrap.min.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/jquery.min.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/swiper-bundle.min.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/carousel.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/bootstrap-select.min.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/lazysize.min.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/count-down.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/wow.min.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/multiple-modal.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/main.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/carrito.js}"></script>

<script th:inline="javascript">

    let currentPage = 0;
    let objetivoIdGlobal = [[${objetivoId}]];

    let dataUsuario = [[${session.usuario}]]
    let selectedVariants = [];
    let producto = "";
    let variacionesParams;
    let urlImagenesProductos='http://104.218.48.244:8080/apirest/api/productos/images-propiedad-detalle/';


    $(document).ready(function() {
        mostrarProductoNuevo(objetivoIdGlobal,currentPage);
    });

    $("#btn-aplicar-filtros").click(function () {
        mostrarProductoNuevo(objetivoIdGlobal,currentPage);
    })

    function mostrarProductoNuevo(objetivoId, page) {
        //let urlImagenesProductos='http://104.218.48.244:8080/apirest/apirest/productos/images/';
        let urlImagenesProductos='http://104.218.48.244:8080/apirest/api/productos/images-propiedad-detalle/';

        let precioMinimo = $(".range-min").val();
        let precioMaximo = $(".range-max").val();

        $.ajax({
            type: "GET",
            url: '/qaweb/producto/obtenerProductosPorObjetivoId',
            dataType: "json",
            data: {
                objetivoId: parseInt(objetivoId),
                minPrecio: parseFloat(precioMinimo),
                maxPrecio:parseFloat(precioMaximo),
                page: parseInt(page)
            },
            success: function (response) {
                console.log(response);
                $("#contenedor-producto").html("");
                $.each(response.productos, function (i, element) {

                    let variacionesParams = element.variaciones.map(function (v, i) {
                        return 'variacion' + (i + 1) + '=' + encodeURIComponent(v.trim());
                    }).join('&');

                    let productoCard = $("<div>").addClass("card-product").attr({
                        "data-price": element.precioReducido,
                        "data-color": "orange black white"
                    });

                    let cardWrapper = $("<div>").addClass("card-product-wrapper").append(
                        $("<a>").addClass("product-img product-link").attr({
                            "href": "/qaweb/"+element.urlMenu+"/" + element.urlMenuSub+ "/" + element.urlCategoria+"/"+
                                element.urlProducto+"?"+variacionesParams,
                        }).append(
                            $("<img>").addClass("lazyload img-product").attr({
                                "data-src": urlImagenesProductos + element.imagen,
                                "src": urlImagenesProductos + element.imagen,
                                "alt": element.nombre
                            }),
                            $("<img>").addClass("lazyload img-hover").attr({
                                "data-src": urlImagenesProductos + element.imagen,
                                "src": urlImagenesProductos + element.imagen,
                                "alt": element.nombre
                            })
                        )
                    );

                    let modalItem = $("<div>").addClass("list-product-btn absolute-2").append(
                        $("<a>").attr({"href": "#quick_add", "data-bs-toggle": "modal"}).data("producto", element).addClass("box-icon bg_white quick-add tf-btn-loading btn-show-detail").append(
                            $("<span>").addClass("icon icon-bag"),
                            $("<span>").addClass("tooltip").text("A침adir R치pido")
                        ),
                        /*$("<a>").attr("href", "javascript:void(0);").addClass("box-icon bg_white wishlist btn-icon-action").append(
                            $("<span>").addClass("icon icon-heart"),
                            $("<span>").addClass("tooltip").text("Add to Wishlist"),
                            $("<span>").addClass("icon icon-delete")
                        ),
                        $("<a>").addClass("box-icon bg_white compare btn-icon-action btn-add-cart").data("producto", element).append(
                            $("<span>").addClass("icon icon-compare"),
                            $("<span>").addClass("tooltip").text("Add to Compare"),
                            $("<span>").addClass("icon icon-check")
                        ),
                        $("<a>").attr({"href": "#quick_view", "data-bs-toggle": "modal"}).addClass("box-icon bg_white quickview tf-btn-loading").append(
                            $("<span>").addClass("icon icon-view"),
                            $("<span>").addClass("tooltip").text("Quick View")
                        )*/
                    );

                    let cardInfo = $("<div>").addClass("card-product-info").append(
                        $("<a>").attr({
                            "href": "/por-marcas/"+element.urlMarca
                        }).addClass("title link text-center").text(element.nombreMarca),
                        $("<a>").attr({
                            "href": "/qaweb/"+element.urlMenu+"/" + element.urlMenuSub+ "/" + element.urlCategoria+"/"+
                                element.urlProducto+"?"+variacionesParams,
                        }).addClass("title link text-center").text(element.nombre)
                    );

                    $.each(element.variaciones, function (j, variacion) {
                        cardInfo.append(
                            $("<a>").addClass("title link text-center").text(variacion)
                        );
                    });

                    const preciosPorRol = {
                        "Cliente": { regular: element.precio, especial: element.precioReducido, labelEspecial: "Precio Reducido:" },
                        "Team": { regular: element.precio, especial: element.precioTeam, labelEspecial: "Precio Team:" },
                        "Team Vip": { regular: element.precio , especial: element.precioTeamVip, labelEspecial: "Precio VIP Team:" },
                        "Familiar": { regular: element.precio , especial: element.precioFamiliar, labelEspecial: "Precio Familiar:" }
                    };

                    // Definir los precios por defecto
                    const preciosDefecto = { regular: element.precio, especial: element.precioReducido, labelEspecial: "Precio Reducido:" };

                    // Obtener los precios basados en el rol del usuario o usar los precios por defecto si el rol es null
                    const precio = dataUsuario && dataUsuario.nombreRolPerfil  ? preciosPorRol[dataUsuario.nombreRolPerfil] : preciosDefecto

                    let priceProduct = $("<div>").addClass("d-flex flex-row justify-content-evenly").append(
                        $("<p>").addClass("d-flex flex-column").text("Precio Regular:").append(
                            $("<span>").addClass("price").text(parseFloat(precio.regular).toFixed(2))
                        ),
                        $("<p>").addClass("d-flex flex-column").text(precio.labelEspecial).append(
                            $("<span>").addClass("price").text(parseFloat(precio.especial).toFixed(2))
                        )
                    )

                    cardInfo.append(priceProduct);
                    productoCard.append(cardWrapper, modalItem).append(cardInfo);
                    $("#contenedor-producto").append(productoCard);
                })
                crearPaginacion(response);
            },
            error: function() {
                console.log('Error al obtener el productos');
            }
        });

        function crearPaginacion(page) {
            let pagination = $(".tf-pagination-list");
            pagination.html("");

            if (page.pagePrevious) {
                pagination.append('<li><a href="#" class="pagination-link" data-page="' + (page.pageNumber - 1) + '">&laquo;</a></li>');
            }
            for (let i = 0; i < page.totalPages; i++) {
                let activeClass = (i === page.pageNumber) ? ' active' : '';
                pagination.append('<li class="' + activeClass + '"><a href="#" class="pagination-link" data-page="' + i + '">' + (i + 1) + '</a></li>');
            }
            if (page.pageNext) {
                pagination.append('<li><a href="#" class="pagination-link" data-page="' + (page.pageNumber + 1) + '">&raquo;</a></li>');
            }

            $(".pagination-link").click(function(e) {
                e.preventDefault();
                currentPage = $(this).data("page");
                mostrarProductoNuevo(objetivoIdGlobal, currentPage);
            });
        }
    }
</script>
</body>
</html>
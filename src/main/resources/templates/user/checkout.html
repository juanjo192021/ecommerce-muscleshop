<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Bienvendidos a MuscleShop</title>

    <meta name="author" content="Muscle">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- font -->
    <link rel="stylesheet" th:href="@{/public/resources/site/general/static/assets/fonts/fonts.css}">
    <!-- Icons -->
    <link rel="stylesheet" th:href="@{/public/resources/site/general/static/assets/fonts/font-icons.css}">
    <link rel="stylesheet" th:href="@{/public/resources/site/general/static/assets/css/bootstrap.min.css}">
    <link rel="stylesheet" th:href="@{/public/resources/site/general/static/assets/css/swiper-bundle.min.css}">
    <link rel="stylesheet" th:href="@{/public/resources/site/general/static/assets/css/animate.css}">
    <link rel="stylesheet" type="text/css" th:href="@{/public/resources/site/general/static/assets/css/styles.css}"/>

    <!-- Favicon and Touch Icons  -->
    <link rel="shortcut icon" th:href="@{/public/resources/site/general/static/images/logo/favicon.png}">
    <link rel="apple-touch-icon-precomposed" th:href="@{/public/resources/site/general/static/images/logo/favicon.png}">
    <script src="https://kit.fontawesome.com/98270ba09b.js" crossorigin="anonymous"></script>
</head>
<body class="preload-wrapper">
<!-- preload -->
<div class="preload preload-container">
    <div class="preload-logo">
        <div class="spinner"></div>
    </div>
</div>
<!-- /preload -->
<div id="wrapper">
    <!-- Top bar -->
    <div th:replace="~{shared/components/top-bar :: top-bar}"></div>
    <!-- /Top bar -->
    <!-- Header -->
    <div th:replace="~{shared/components/header :: header}"></div>
    <!-- /Header -->

    <!-- page-title -->
    <div class="tf-page-title">
        <div class="container-full">
            <div class="heading text-center">Finalizar compra</div>
        </div>
    </div>
    <!-- /page-title -->

    <!-- page-cart -->
    <section class="flat-spacing-11">
        <div class="container">
            <div class="tf-page-cart-wrap layout-2">
                <div class="tf-page-cart-item">
                    <div class="row m-0 p-0 row-gap-5">
                        <div class="rounded border border-black border-opacity-25 py-3">
                            <div class="row mx-0 p-0 mb_20">
                                <div class="col-1 rounded-circle bg-danger p-0" style="width: 40px;">
                                    <h5 class="fw-5 text-center text-white">1</h5>
                                </div>
                                <div class="col-11">
                                    <h5 class="fw-5">Identificación</h5>
                                </div>
                            </div>
                            <form class="form-checkout">
                                <div class="box grid-2">
                                    <fieldset class="fieldset">
                                        <label for="nombres">Nombres</label>
                                        <input type="text" id="nombres" name="nombres" placeholder="Ingrese sus Nombres" required>
                                    </fieldset>
                                    <fieldset class="fieldset">
                                        <label for="apellidos">Apellidos</label>
                                        <input type="text" id="apellidos" name="apellidos" placeholder="Ingrese sus Apellidos" required>
                                    </fieldset>
                                </div>
                                <div class="box grid-2">
                                    <fieldset class="fieldset">
                                        <label for="correo">Correo Electrónico</label>
                                        <input type="email" id="correo" name="correo" placeholder="Ingrese su Correo Electrónico" required>
                                    </fieldset>
                                    <fieldset class="box fieldset">
                                        <label for="celular">Celular</label>
                                        <input type="tel" id="celular" name="celular" required>
                                    </fieldset>
                                </div>
                                <div class="box grid-2">
                                    <fieldset class="box fieldset mb-0">
                                        <label for="tipo-documento">Tipo de Documento</label>
                                        <div class="select-custom">
                                            <select class="tf-select w-100" id="tipo-documento" name="tipo-documento" required>
                                                <option disabled selected>Seleccionar</option>
                                                <option value="DNI">DNI</option>
                                                <option value="CE">CE</option>
                                                <option value="Pasaporte">Pasaporte</option>
                                            </select>
                                        </div>
                                    </fieldset>
                                    <fieldset class="fieldset">
                                        <label for="nro-documento">Número de Documento</label>
                                        <input type="text" id="nro-documento" placeholder="Ingrese su Número de Documento" required>
                                    </fieldset>
                                </div>
                                <div class="box grid-2">
                                    <fieldset class="fieldset">
                                        <label for="fecha-nacimiento">Fecha de Nacimiento</label>
                                        <input type="date" id="fecha-nacimiento" name="fecha-nacimiento">
                                    </fieldset>
                                </div>
                            </form>
                        </div>
                        <div class="rounded border border-black border-opacity-25 py-3">
                            <div class="row mx-0 p-0 mb_20">
                                <div class="col-1 rounded-circle bg-danger p-0" style="width: 40px;">
                                    <h5 class="fw-5 text-center text-white">2</h5>
                                </div>
                                <div class="col-11">
                                    <h5 class="fw-5">Seleccionar Comprobante de Pago</h5>
                                </div>
                            </div>
                            <form class="form-checkout">
                                <div class="box grid-2">
                                    <fieldset class="box fieldset mb-0">
                                        <label for="tipo-comprobante">Comprobante de Pago</label>
                                        <div class="select-custom">
                                            <select class="tf-select w-100" id="tipo-comprobante" name="tipo-comprobante">
                                                <option disabled >Seleccionar</option>
                                                <option value="Boleta" name="boleta" selected>Boleta</option>
                                                <option value="Factura" name="factura" >Factura</option>
                                            </select>
                                        </div>
                                    </fieldset>
                                    <fieldset class="fieldset fieldset-ruc  d-none">
                                        <label for="razon-social">Razón Social</label>
                                        <input type="text" id="razon-social" placeholder="Ingrese su Razón Social">
                                    </fieldset>
                                </div>
                                <div class="box grid-2">
                                    <fieldset class="fieldset fieldset-ruc d-none">
                                        <label for="ruc">RUC</label>
                                        <input type="text" id="ruc" placeholder="Ingrese su RUC">
                                    </fieldset>
                                    <fieldset class="fieldset fieldset-ruc d-none">
                                        <label for="last-name">Dirección de Facturación</label>
                                        <input type="text" id="last-name" placeholder="Ingrese su Dirección de Facturación">
                                    </fieldset>
                                </div>
                            </form>
                        </div>
                        <div class="rounded border border-black border-opacity-25 py-3">
                            <div class="row mx-0 p-0 mb_20">
                                <div class="col-1 rounded-circle bg-danger p-0" style="width: 40px;">
                                    <h5 class="fw-5 text-center text-white">3</h5>
                                </div>
                                <div class="col-11">
                                    <h5 class="fw-5">Envío</h5>
                                </div>
                            </div>
                            <form class="form-checkout">

                                <div class="box grid-2">
                                    <fieldset class="fieldset">
                                        <label for="first-name">Dirección</label>
                                        <input type="text" id="first-name" placeholder="Ingrese su Dirección">
                                    </fieldset>
                                    <fieldset class="fieldset">
                                        <label for="first-name">Número</label>
                                        <input type="text" id="first-name" placeholder="Dpto. / Interior / Piso / Lote / Bloque (opcional)">
                                    </fieldset>
                                </div>
                                <div class="box grid-2">
                                    <fieldset class="fieldset">
                                        <label for="first-name">Referencia</label>
                                        <input type="text" id="first-name" placeholder="Ingrese su Referencia">
                                    </fieldset>
                                    <fieldset class="box fieldset mb-0">
                                        <label for="id_region">Departamento</label>
                                        <div class="select-custom">
                                            <select class="tf-select w-100" id="id_region">
                                                <option disabled selected>Seleccionar</option>
                                            </select>
                                        </div>
                                    </fieldset>
                                </div>
                                <div class="box grid-2">
                                    <fieldset class="box fieldset mb-0">
                                        <label for="id_provincia">Provincia</label>
                                        <div class="select-custom">
                                            <select class="tf-select w-100" id="id_provincia">
                                                <option disabled selected>Seleccionar</option>
                                            </select>
                                        </div>
                                    </fieldset>
                                    <fieldset class="box fieldset mb-0">
                                        <label for="id_distrito">Distrito</label>
                                        <div class="select-custom">
                                            <select class="tf-select w-100" id="id_distrito" name="address[country]" data-default="">
                                                <option disabled selected>Seleccionar</option>
                                            </select>
                                        </div>
                                    </fieldset>
                                </div>
                                <div class="box">
                                    <!--<div class="btn-group w-100 pb-3">
                                        <a href="#" class="btn btn-danger active" aria-current="page">Enviar a la dirección</a>
                                        <a href="#" class="btn btn-white text-secondary border border-black border-opacity-25">Recoger en la tienda</a>
                                    </div>-->
                                    <p class="pb-4">SI TU DIRECCIÓN ES DIFICIL, POR FAVOR AYÚDANOS MARCANDO EN EL MAPA</p>
                                    <div class="bo">
                                        <!-- map -->
                                        <div class="w-100">
                                            <iframe src="https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d317859.6089702069!2d-0.075949!3d51.508112!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x48760349331f38dd%3A0xa8bf49dde1d56467!2sTower%20of%20London!5e0!3m2!1sen!2sus!4v1719221598456!5m2!1sen!2sus"
                                                    width="100%"
                                                    height="250"
                                                    style="border:0;"
                                                    allowfullscreen=""
                                                    loading="lazy"
                                                    referrerpolicy="no-referrer-when-downgrade">
                                            </iframe>
                                        </div>
                                        <!-- /map -->
                                    </div>
                                </div>
                            </form>
                        </div>

                        <div class="rounded border border-black border-opacity-25 py-3">
                            <div class="row mx-0 p-0 mb_20">
                                <div class="col-1 rounded-circle bg-danger p-0" style="width: 40px;">
                                    <h5 class="fw-5 text-center text-white">4</h5>
                                </div>
                                <div class="col-11">
                                    <h5 class="fw-5">Pago</h5>
                                </div>
                            </div>
                            <form class="form-checkout">
                                <!--<fieldset class="box fieldset">
                                    <label for="city" class="d-none visually-hidden">Town/City</label>
                                    <input type="text" id="city" placeholder="Utiliza un cupón de regalo">
                                </fieldset>-->
                                <div class="box">
                                    <div class="btn-group w-100 pb-3">
                                       <a href="#" class="btn btn-danger active" aria-current="page">Tarjeta de Crédito o Débito</a>
                                       <a href="#" class="btn btn-white text-secondary border border-black border-opacity-25">Cuentas bancarias</a>
                                       <a href="#" class="btn btn-white text-secondary border border-black border-opacity-25">Yape / Plin</a>
                                   </div>
                                    <div class="footer-bottom-wrap d-flex gap-20 flex-wrap justify-content-end align-items-center">
                                        <div class="tf-payment">
                                            <img src="https://themesflat.co/html/ecomus/images/payments/visa.png" alt="">
                                            <img src="https://themesflat.co/html/ecomus/images/payments/img-1.png" alt="">
                                            <img src="https://themesflat.co/html/ecomus/images/payments/img-2.png" alt="">
                                            <img src="https://themesflat.co/html/ecomus/images/payments/img-3.png" alt="">
                                            <img src="https://themesflat.co/html/ecomus/images/payments/img-4.png" alt="">
                                        </div>
                                    </div>
                                </div>
                                <div>
                                    <a class="btn btn-primary"> Finalizar compra en Mercado Pago</a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <div class="tf-page-cart-footer">
                    <div class="tf-cart-footer-inner">
                        <h5 class="fw-5 mb_20">Tu orden</h5>
                        <form class="tf-page-cart-checkout widget-wrap-checkout">
                            <ul class="wrap-checkout-product" id="contenedor-productos-checkout">
                                <!--<li class="checkout-product-item">
                                    <figure class="img-product">
                                        <img src="https://themesflat.co/html/ecomus/images/products/brown.jpg" alt="product">
                                        <span class="quantity">1</span>
                                    </figure>
                                    <div class="content">
                                        <div class="info">
                                            <p class="name">Ribbed modal T-shirt</p>
                                            <span class="variant">Brown / M</span>
                                        </div>
                                        <span class="price">$25.00</span>
                                    </div>
                                </li>-->
                            </ul>
                            <div class="coupon-box">
                                <input type="text" placeholder="Código de Descuento">
                                <a href="#" class="tf-btn btn-sm radius-3 btn-fill btn-icon animate-hover-btn">Aplicar</a>
                            </div>
                            <div class="d-flex justify-content-between line pb_20">
                                <h6 class="fw-5">Total</h6>
                                <h6 class="total fw-5">$122.00</h6>
                            </div>
                            <!--<div class="wd-check-payment">
                                <div class="fieldset-radio mb_20">
                                    <input type="radio" name="payment" id="bank" class="tf-check" checked>
                                    <label for="bank">Direct bank transfer</label>
                                </div>
                                <div class="fieldset-radio mb_20">
                                    <input type="radio" name="payment" id="delivery" class="tf-check">
                                    <label for="delivery">Cash on delivery</label>
                                </div>
                                <p class="text_black-2 mb_20">Your personal data will be used to process your order, support your experience throughout this website, and for other purposes described in our <a href="privacy-policy.html" class="text-decoration-underline">privacy policy</a>.</p>
                                <div class="box-checkbox fieldset-radio mb_20">
                                    <input type="checkbox" id="check-agree" class="tf-check">
                                    <label for="check-agree" class="text_black-2">I have read and agree to the website <a href="terms-conditions.html" class="text-decoration-underline">terms and conditions</a>.</label>
                                </div>
                            </div>
                            <button class="tf-btn radius-3 btn-fill btn-icon animate-hover-btn justify-content-center">Place order</button>-->
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- page-cart -->

    <!-- Footer -->
    <div th:replace="~{shared/components/footer :: footer}"></div>
    <!-- /Footer -->

</div>

<!-- gotop: Componente que hace dirigirte a lo más alto de la página web-->
<div th:replace="~{shared/components/gotop :: gotop}"></div>
<!-- /gotop -->

<!-- toolbar-bottom: Componente inferior cuando es mobile similar a un toolbar-->
<div th:replace="~{shared/components/toolbar-bottom :: toolbar-bottom}"></div>
<!-- /toolbar-bottom -->

<!-- all-modals: Todos los modales -->
<div th:replace="~{shared/modals/all-modals :: all-modals}"></div>
<!-- /all-modals -->

<!-- Javascript -->
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/bootstrap.min.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/jquery.min.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/swiper-bundle.min.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/carousel.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/bootstrap-select.min.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/lazysize.min.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/count-down.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/wow.min.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/multiple-modal.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/main.js}"></script>
<script type="text/javascript" th:src="@{/public/resources/site/general/static/assets/js/carrito.js}"></script>
<script th:inline="javascript">
    let dataUsuario = [[${session.usuario}]]
    let selectedVariants = [];
    let producto = "";
    let variacionesParams;
    let urlImagenesProductos='http://104.218.48.244:8080/apirest/api/productos/images-propiedad-detalle/';

    $(document).ready(function () {
        autocompletarInformacion();
        mostrarCheckout();
        $('#tipo-comprobante').on('change', function () {
            if ($(this).val() === 'Factura') {
                // Mostrar campos para Factura
                $('.fieldset-ruc').removeClass('d-none');
            } else if ($(this).val() === 'Boleta') {
                // Ocultar campos para Boleta
                $('.fieldset-ruc').addClass('d-none');
            }
        });

        $.getJSON("/usuario/listaRegion", function (data) {
            $.each(data, function (i, item) {
                $("#id_region").append("<option value='" + item + "'>" + item + "</option>");
            });
        });
        $("#id_region").change(function () {
            var var_reg = $("#id_region").val();
            $("#id_provincia").empty();
            $("#id_provincia").append("<option value=''>Selecciona una provincia </option>");

            $("#id_distrito").empty();
            $("#id_distrito").append("<option value=''>Selecciona un distrito </option>");

            $.getJSON("/usuario/listaProvincia", {"region": var_reg}, function (data) {
                $.each(data, function (i, item) {
                    $("#id_provincia").append("<option value='" + item + "'>" + item + "</option>");
                });
            });
        });

        $("#id_provincia").change(function () {
            var var_reg = $("#id_region").val();
            var var_pro = $("#id_provincia").val();
            $("#id_distrito").empty();
            $("#id_distrito").append("<option value=''>Selecciona un distrito </option>");

            $.getJSON("/usuario/listaDistrito", {"region": var_reg, "provincia": var_pro}, function (data) {
                $.each(data, function (i, item) {
                    $("#id_distrito").append("<option value='" + item.id + "'>" + item.distrito + "</option>");
                });
            });
        });
        $("#id_distrito").change(function () {
            var var_reg = $("#id_region").val();
            var var_pro = $("#id_provincia").val();
            var var_dis = $("#id_distrito").val();
            $("#ubigeo_id").val(var_dis);

            $.getJSON("/usuario/listaDistrito", {"region": var_reg, "provincia": var_pro}, function (data) {
                var costoEnvio;
                $.each(data, function (i, item) {
                    if (item.id == var_dis) {
                        costoEnvio = parseFloat(item.costo);
                        console.log({costoEnvio})
                        return false;
                    }
                });
                /*$("#envio-cost").text("S/." + costoEnvio.toFixed(2));
                var subtotalText = $("#subtotal-price").text().replace('S/.', '').trim();
                var subtotal = parseFloat(subtotalText);
                var nuevoTotal = subtotal + costoEnvio;

                $("#total-price").text("S/." + nuevoTotal.toFixed(2));*/
            });

        });
    })

    function autocompletarInformacion(){
        console.log({dataUsuario});
        if(dataUsuario){
            $('#nombres').val(dataUsuario.nombres);
            $('#apellidos').val(dataUsuario.apellidos);
            $('#correo').val(dataUsuario.correo);
            $('#celular').val(dataUsuario.telefono);
            $('#tipo-documento').val(dataUsuario.tipoDocumento)
            $('#nro-documento').val(dataUsuario.nroDocumento)
            $('#fecha-nacimiento').val(dataUsuario.fechaNacimiento)
        }
    }

    function mostrarCheckout(){

        $("#contenedor-productos-checkout").html("");
        let carrito = JSON.parse(localStorage.getItem("carrito")) || [];
        let subtotal = 0;

        console.log({carrito});
        carrito.forEach((item,index) => {

            variacionesParams = item.producto.variaciones.map(function (v, i) {
                return 'variacion' + (i + 1) + '=' + encodeURIComponent(v.trim());
            }).join('&');

            let cartItem = $("<div>").addClass("checkout-product-item");

            let cartImage = $("<figure>").addClass("img-product").append(
                $("<a>").attr({
                    "href": "/qaweb/"+item.producto.urlMenu+"/" + item.producto.urlMenuSub+ "/" + item.producto.urlCategoria+"/"+
                        item.producto.urlProducto+"?"+variacionesParams,
                }).append(
                    $("<img>").attr({"src": urlImagenesProductos + item.producto.imagen}).attr("alt", item.producto.nombre),
                    $("<span>").addClass("quantity").text(item.cantidad)
                )
            );

            const preciosDefecto = { regular: item.producto.precio, especial: item.producto.precioReducido, labelEspecial: "Precio Reducido:" };

            const preciosPorRol = {
                "Cliente": { regular: item.producto.precio, especial: item.producto.precioReducido, labelEspecial: "Precio Reducido:" },
                "Team": { regular: item.producto.precio, especial: item.producto.precioTeam, labelEspecial: "Precio Team:" },
                "Team Vip": { regular: item.producto.precio, especial: item.producto.precioTeamVip, labelEspecial: "Precio VIP Team:" },
                "Familiar": { regular: item.producto.precio, especial: item.producto.precioFamiliar, labelEspecial: "Precio VIP Team:" }
            };

            const precio = (dataUsuario && dataUsuario.nombreRolPerfil) ? preciosPorRol[dataUsuario.nombreRolPerfil] : preciosDefecto;
            subtotal += precio.especial * item.cantidad;

            let cartInfo = $("<div>").addClass("content")
                .append(
                    $("<div>").addClass("info").append(
                        $("<a>").addClass("title link").attr({
                            "href": "/qaweb/"+item.producto.urlMenu+"/" + item.producto.urlMenuSub+ "/" + item.producto.urlCategoria+"/"+
                                item.producto.urlProducto+"?"+variacionesParams,
                        }).append(
                            $("<p>").addClass("name").text(item.producto.nombre),
                            $("<span>").addClass("variant").text(item.producto.variacion),
                        ),
                    ),
                    $("<span>").addClass("price").text(`S/. ${parseFloat(precio.especial).toFixed(2)}`)
                );
            cartItem.append(cartImage, cartInfo);
            $("#contenedor-productos-checkout").append(cartItem);
        })

        $(".total").text(`S/. ${subtotal.toFixed(2)}`);
    }
</script>
</body>
</html>